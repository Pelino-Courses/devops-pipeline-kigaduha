---
- name: Configure and deploy DevOps Pipeline application
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # Database configuration
    db_user: "{{ lookup('env', 'DB_USER') | default('postgres', true) }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') }}"
    db_name: "{{ lookup('env', 'DB_NAME') | default('taskdb', true) }}"

    # Container Registry configuration
    docker_registry: "{{ lookup('env', 'DOCKER_REGISTRY') | default('ghcr.io', true) }}"
    image_name: "{{ lookup('env', 'IMAGE_NAME') | default('pelino-courses/devops-pipeline-kigaduha', true) }}"
    registry_username: "{{ lookup('env', 'REGISTRY_USERNAME') }}"
    registry_password: "{{ lookup('env', 'REGISTRY_PASSWORD') }}"
    acr_username: "{{ lookup('env', 'ACR_USERNAME') | default('00000000-0000-0000-0000-000000000000', true) }}"
    acr_password: "{{ lookup('env', 'ACR_PASSWORD') | default(lookup('env', 'AZURE_CLIENT_SECRET'), true) }}"

    # Application configuration
    image_tag: "{{ lookup('env', 'IMAGE_TAG') | default('main', true) }}"
    secret_key: "{{ lookup('env', 'SECRET_KEY') | default(lookup('password', '/dev/null length=32 chars=ascii_letters'), true) }}"
    vm_public_ip: "{{ ansible_facts['default_ipv4']['address'] }}"

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

    - name: Validate required variables
      assert:
        that:
          - db_password is defined and db_password != ''
          - docker_registry is defined and docker_registry != ''
        fail_msg: "Required environment variables are not set. Check DB_PASSWORD and DOCKER_REGISTRY."

  roles:
    - docker
    - security
    - app-deploy

  post_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "======================================"
          - "Deployment completed successfully!"
          - "======================================"
          - "Frontend URL: http://{{ vm_public_ip }}"
          - "Backend API: http://{{ vm_public_ip }}:5000"
          - "======================================"
